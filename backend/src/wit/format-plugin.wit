package artifact-keeper:format@1.0.0;

/// Format handler interface for WASM plugins.
///
/// Plugins implement this interface to provide custom artifact format handling.
/// The host (Artifact Keeper) calls these functions when processing artifacts.
interface handler {
    /// Artifact metadata returned by parse-metadata.
    record metadata {
        /// The artifact path within the repository.
        path: string,
        /// Extracted version (if applicable to the format).
        version: option<string>,
        /// MIME content type for the artifact.
        content-type: string,
        /// Size of the artifact in bytes.
        size-bytes: u64,
        /// SHA-256 checksum (host may calculate if not provided).
        checksum-sha256: option<string>,
    }

    /// Validation error details.
    record validation-error {
        /// Human-readable error message.
        message: string,
        /// Field or path component that caused the error (if applicable).
        field: option<string>,
    }

    /// Returns the format key this handler supports.
    /// Must match the format.key in plugin.toml.
    format-key: func() -> string;

    /// Parse metadata from artifact content.
    /// Called when an artifact is uploaded to extract format-specific metadata.
    ///
    /// # Arguments
    /// * `path` - The artifact path within the repository
    /// * `data` - The artifact content bytes
    ///
    /// # Returns
    /// * `Ok(metadata)` - Successfully parsed metadata
    /// * `Err(message)` - Parse failed with error description
    parse-metadata: func(path: string, data: list<u8>) -> result<metadata, string>;

    /// Validate artifact before storage.
    /// Called to verify the artifact is valid for this format.
    ///
    /// # Arguments
    /// * `path` - The artifact path within the repository
    /// * `data` - The artifact content bytes
    ///
    /// # Returns
    /// * `Ok(())` - Artifact is valid
    /// * `Err(message)` - Artifact is invalid with error description
    validate: func(path: string, data: list<u8>) -> result<_, string>;

    /// Generate index files for repository.
    /// Called to generate format-specific index/metadata files (e.g., maven-metadata.xml).
    ///
    /// # Arguments
    /// * `artifacts` - List of artifact metadata in the repository
    ///
    /// # Returns
    /// * `Ok(Some(files))` - List of (path, content) tuples for index files
    /// * `Ok(None)` - No index files needed for this format
    /// * `Err(message)` - Index generation failed
    generate-index: func(artifacts: list<metadata>) -> result<option<list<tuple<string, list<u8>>>>, string>;
}

/// World definition for format handler plugins.
/// Plugins must export the handler interface.
world format-plugin {
    /// Export the format handler interface.
    export handler;
}
