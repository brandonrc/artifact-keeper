name: Scheduled Container Scan

on:
  schedule:
    # Every Monday at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ${{ github.repository }}-backend
  OPENSCAP_IMAGE: ${{ github.repository }}-openscap

jobs:
  trivy-scan:
    name: Weekly Trivy Scan
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: read
      security-events: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Trivy scan - Backend
        uses: aquasecurity/trivy-action@0.34.1
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest
          format: 'sarif'
          output: 'backend-trivy.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'

      - name: Trivy scan - OpenSCAP
        uses: aquasecurity/trivy-action@0.34.1
        if: always()
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.OPENSCAP_IMAGE }}:latest
          format: 'sarif'
          output: 'openscap-trivy.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'

      - name: Trivy scan - Backend Alpine
        uses: aquasecurity/trivy-action@0.34.1
        if: always()
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest-alpine
          format: 'sarif'
          output: 'backend-alpine-trivy.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'

      - name: Upload Backend Trivy SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'backend-trivy.sarif'
          category: 'trivy-backend-scheduled'

      - name: Upload OpenSCAP Trivy SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'openscap-trivy.sarif'
          category: 'trivy-openscap-scheduled'

      - name: Upload Backend Alpine Trivy SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'backend-alpine-trivy.sarif'
          category: 'trivy-backend-alpine-scheduled'

      - name: Upload Trivy reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: trivy-weekly-reports
          path: |
            backend-trivy.sarif
            openscap-trivy.sarif
            backend-alpine-trivy.sarif
          retention-days: 90

      - name: Check for new findings and create issue
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            let totalFindings = 0;
            const summaries = [];

            for (const [name, file] of [['Backend', 'backend-trivy.sarif'], ['OpenSCAP', 'openscap-trivy.sarif'], ['Backend Alpine', 'backend-alpine-trivy.sarif']]) {
              if (!fs.existsSync(file)) {
                summaries.push(`- **${name}**: Scan skipped or failed`);
                continue;
              }
              const sarif = JSON.parse(fs.readFileSync(file, 'utf8'));
              const results = sarif.runs?.[0]?.results || [];
              const count = results.length;
              totalFindings += count;
              summaries.push(`- **${name}**: ${count} finding(s)`);
            }

            console.log(`Total findings: ${totalFindings}`);
            console.log(summaries.join('\n'));

            if (totalFindings > 0) {
              // Check if there's already an open issue for container findings
              const existing = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'security',
                per_page: 100
              });

              const hasExisting = existing.data.some(i =>
                i.title.includes('Container scan findings')
              );

              if (!hasExisting) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `Container scan findings detected (${new Date().toISOString().split('T')[0]})`,
                  body: [
                    '## Weekly Container Scan Results',
                    '',
                    `Trivy found **${totalFindings}** CRITICAL/HIGH finding(s) with available fixes:`,
                    '',
                    ...summaries,
                    '',
                    `[View scan run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                    '',
                    'SARIF reports have been uploaded to the Security tab and as workflow artifacts.',
                  ].join('\n'),
                  labels: ['security']
                });
              }
            }

      - name: Scan summary
        if: always()
        run: |
          echo "## Weekly Container Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: $([ -f backend-trivy.sarif ] && echo 'Scanned' || echo 'Skipped')" >> $GITHUB_STEP_SUMMARY
          echo "- **OpenSCAP**: $([ -f openscap-trivy.sarif ] && echo 'Scanned' || echo 'Skipped')" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Alpine**: $([ -f backend-alpine-trivy.sarif ] && echo 'Scanned' || echo 'Skipped')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "SARIF reports uploaded to Security tab and as workflow artifacts." >> $GITHUB_STEP_SUMMARY
