name: Docker Publish

on:
  push:
    branches: [main, master]
    tags: ['v*']
    paths-ignore:
      - '**/*.md'
      - '.beads/**'
      - 'LICENSE'
      - 'CLAUDE.md'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag (e.g., v1.0.0, latest)'
        required: true
        default: 'latest'

permissions: {}

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ${{ github.repository }}-backend
  OPENSCAP_IMAGE: ${{ github.repository }}-openscap
  DOCKERHUB_BACKEND: artifactkeeper/backend
  DOCKERHUB_OPENSCAP: artifactkeeper/openscap

jobs:
  build-backend:
    name: Backend (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    outputs:
      digest-amd64: ${{ steps.build.outputs.digest }}
      digest-arm64: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.backend
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,name=${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=backend-${{ matrix.platform }}
          cache-to: type=gha,scope=backend-${{ matrix.platform }},mode=max
          sbom: true
          provenance: mode=max

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v6
        with:
          name: backend-digests-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  build-openscap:
    name: OpenSCAP (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    outputs:
      digest-amd64: ${{ steps.build.outputs.digest }}
      digest-arm64: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.OPENSCAP_IMAGE }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.openscap
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,name=${{ env.REGISTRY }}/${{ env.OPENSCAP_IMAGE }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=openscap-${{ matrix.platform }}
          cache-to: type=gha,scope=openscap-${{ matrix.platform }},mode=max
          sbom: true
          provenance: mode=max

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v6
        with:
          name: openscap-digests-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  scan-containers:
    name: Security Scan
    runs-on: ubuntu-24.04
    needs: [build-backend, build-openscap]
    permissions:
      contents: read
      packages: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download backend amd64 digest
        uses: actions/download-artifact@v7
        with:
          name: backend-digests-amd64
          path: /tmp/backend-digests

      - name: Download openscap amd64 digest
        uses: actions/download-artifact@v7
        with:
          name: openscap-digests-amd64
          path: /tmp/openscap-digests

      - name: Resolve image references
        id: refs
        run: |
          BACKEND_DIGEST=$(ls /tmp/backend-digests/)
          OPENSCAP_DIGEST=$(ls /tmp/openscap-digests/)
          echo "backend=${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}@sha256:${BACKEND_DIGEST}" >> $GITHUB_OUTPUT
          echo "openscap=${{ env.REGISTRY }}/${{ env.OPENSCAP_IMAGE }}@sha256:${OPENSCAP_DIGEST}" >> $GITHUB_OUTPUT

      # --- Trivy CVE scanning ---
      # --ignore-unfixed: only fail on CVEs with available patches.
      # Unpatched UBI base image CVEs (Red Hat's responsibility) are still
      # reported in SARIF for visibility but don't block the build.
      # Trivy scans upload SARIF to GitHub Security tab for visibility.
      # exit-code: 0 means scan results are informational â€” unfixed base image
      # CVEs (Red Hat's responsibility) should not block image publishing.
      - name: Trivy scan - Backend
        uses: aquasecurity/trivy-action@0.34.1
        with:
          image-ref: ${{ steps.refs.outputs.backend }}
          format: 'sarif'
          output: 'backend-trivy.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'

      - name: Trivy scan - OpenSCAP
        uses: aquasecurity/trivy-action@0.34.1
        if: always()
        with:
          image-ref: ${{ steps.refs.outputs.openscap }}
          format: 'sarif'
          output: 'openscap-trivy.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'

      - name: Upload Backend Trivy SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'backend-trivy.sarif'
          category: 'trivy-backend'

      - name: Upload OpenSCAP Trivy SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'openscap-trivy.sarif'
          category: 'trivy-openscap'

      - name: Upload Trivy reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: trivy-scan-reports
          path: |
            backend-trivy.sarif
            openscap-trivy.sarif
          retention-days: 90

      # --- OpenSCAP STIG compliance scan ---
      - name: Install OpenSCAP
        if: always()
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq openscap-utils rpm2cpio

      - name: Download SCAP Security Guide (RHEL 9 STIG content)
        if: always()
        run: |
          SSG_VERSION=$(curl -sI "https://github.com/ComplianceAsCode/content/releases/latest" | grep -i ^location | sed 's|.*/||' | tr -d '\r')
          curl -sSfL -o /tmp/ssg.zip \
            "https://github.com/ComplianceAsCode/content/releases/download/${SSG_VERSION}/scap-security-guide-${SSG_VERSION#v}.zip"
          mkdir -p /tmp/ssg && unzip -q /tmp/ssg.zip -d /tmp/ssg
          SSG_DS=$(find /tmp/ssg -name "ssg-rhel9-ds.xml" | head -1)
          echo "SSG_DS=${SSG_DS}" >> $GITHUB_ENV

      - name: STIG scan - Backend
        if: always()
        run: |
          docker pull ${{ steps.refs.outputs.backend }}
          CID=$(docker create ${{ steps.refs.outputs.backend }})
          mkdir -p /tmp/rootfs/backend
          docker export ${CID} | tar -xf - -C /tmp/rootfs/backend
          docker rm ${CID}

          oscap xccdf eval \
            --profile xccdf_org.ssgproject.content_profile_stig \
            --results backend-stig-results.xml \
            --report backend-stig-report.html \
            --chroot /tmp/rootfs/backend \
            "${SSG_DS}" || true

      - name: STIG scan - OpenSCAP
        if: always()
        run: |
          docker pull ${{ steps.refs.outputs.openscap }}
          CID=$(docker create ${{ steps.refs.outputs.openscap }})
          mkdir -p /tmp/rootfs/openscap
          docker export ${CID} | tar -xf - -C /tmp/rootfs/openscap
          docker rm ${CID}

          oscap xccdf eval \
            --profile xccdf_org.ssgproject.content_profile_stig \
            --results openscap-stig-results.xml \
            --report openscap-stig-report.html \
            --chroot /tmp/rootfs/openscap \
            "${SSG_DS}" || true

      - name: Upload STIG reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: stig-compliance-reports
          path: |
            *-stig-report.html
            *-stig-results.xml
          retention-days: 90

      - name: STIG compliance summary
        if: always()
        run: |
          echo "## Container Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Trivy CVE Scan" >> $GITHUB_STEP_SUMMARY
          echo "- **Policy**: Fail on CRITICAL or HIGH severity CVEs" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: $([ -f backend-trivy.sarif ] && echo 'Scanned' || echo 'Skipped')" >> $GITHUB_STEP_SUMMARY
          echo "- **OpenSCAP**: $([ -f openscap-trivy.sarif ] && echo 'Scanned' || echo 'Skipped')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### OpenSCAP STIG Compliance" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile**: DISA STIG for RHEL 9" >> $GITHUB_STEP_SUMMARY
          echo "- HTML reports uploaded as workflow artifacts" >> $GITHUB_STEP_SUMMARY

  merge-backend:
    name: Backend Multi-Arch Manifest
    runs-on: ubuntu-latest
    needs: [build-backend]
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - name: Download digests
        uses: actions/download-artifact@v7
        with:
          path: /tmp/digests
          pattern: backend-digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata (ghcr.io)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=dev,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-') }}
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}

      - name: Extract metadata (Docker Hub)
        id: meta-dockerhub
        uses: docker/metadata-action@v5
        with:
          images: docker.io/${{ env.DOCKERHUB_BACKEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=dev,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-') }}
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}

      - name: Create manifest list and push (ghcr.io)
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}@sha256:%s ' *)
        env:
          DOCKER_METADATA_OUTPUT_JSON: ${{ steps.meta.outputs.json }}

      - name: Inspect image
        id: inspect
        run: |
          docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.version }}
          DIGEST=$(docker buildx imagetools inspect --format '{{json .Manifest}}' \
            ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.version }} | jq -r '.digest')
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      - name: Copy to Docker Hub
        run: |
          docker buildx imagetools create \
            $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< '${{ steps.meta-dockerhub.outputs.json }}') \
            ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}@${{ steps.inspect.outputs.digest }}

      - name: Sign image with cosign (keyless)
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}@${{ steps.inspect.outputs.digest }}

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v4
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}
          subject-digest: ${{ steps.inspect.outputs.digest }}
          push-to-registry: true
        continue-on-error: true

      - name: Checkout (for VEX files)
        uses: actions/checkout@v6
        with:
          sparse-checkout: .vex

      - name: Attach VEX attestations
        run: |
          for vex in .vex/*.vex.json; do
            [ -f "$vex" ] || continue
            echo "Attaching VEX: $vex"
            docker scout attestation add \
              --file "$vex" \
              --predicate-type https://openvex.dev/ns/v0.2.0 \
              ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}@${{ steps.inspect.outputs.digest }}
          done
        continue-on-error: true

  merge-openscap:
    name: OpenSCAP Multi-Arch Manifest
    runs-on: ubuntu-latest
    needs: [build-openscap]
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - name: Download digests
        uses: actions/download-artifact@v7
        with:
          path: /tmp/digests
          pattern: openscap-digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata (ghcr.io)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.OPENSCAP_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=dev,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-') }}
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}

      - name: Extract metadata (Docker Hub)
        id: meta-dockerhub
        uses: docker/metadata-action@v5
        with:
          images: docker.io/${{ env.DOCKERHUB_OPENSCAP }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=dev,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-') }}
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}

      - name: Create manifest list and push (ghcr.io)
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.REGISTRY }}/${{ env.OPENSCAP_IMAGE }}@sha256:%s ' *)
        env:
          DOCKER_METADATA_OUTPUT_JSON: ${{ steps.meta.outputs.json }}

      - name: Inspect image
        id: inspect
        run: |
          docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.OPENSCAP_IMAGE }}:${{ steps.meta.outputs.version }}
          DIGEST=$(docker buildx imagetools inspect --format '{{json .Manifest}}' \
            ${{ env.REGISTRY }}/${{ env.OPENSCAP_IMAGE }}:${{ steps.meta.outputs.version }} | jq -r '.digest')
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      - name: Copy to Docker Hub
        run: |
          docker buildx imagetools create \
            $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< '${{ steps.meta-dockerhub.outputs.json }}') \
            ${{ env.REGISTRY }}/${{ env.OPENSCAP_IMAGE }}@${{ steps.inspect.outputs.digest }}

      - name: Sign image with cosign (keyless)
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.OPENSCAP_IMAGE }}@${{ steps.inspect.outputs.digest }}

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v4
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.OPENSCAP_IMAGE }}
          subject-digest: ${{ steps.inspect.outputs.digest }}
          push-to-registry: true
        continue-on-error: true

  summary:
    name: Publish Summary
    runs-on: ubuntu-latest
    permissions: {}
    needs: [merge-backend, merge-openscap]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Docker Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`docker.io/${{ env.DOCKERHUB_BACKEND }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### OpenSCAP" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.OPENSCAP_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`docker.io/${{ env.DOCKERHUB_OPENSCAP }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Supply Chain Security" >> $GITHUB_STEP_SUMMARY
          echo "- All images signed with [cosign](https://docs.sigstore.dev/cosign/overview/) keyless signing (GitHub OIDC)" >> $GITHUB_STEP_SUMMARY
          echo "- Verify: \`cosign verify --certificate-oidc-issuer=https://token.actions.githubusercontent.com --certificate-identity-regexp='https://github.com/artifact-keeper/.*' ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
