# Implementation Plan: Staged Testing Strategy for CI/CD

**Branch**: `005-staged-testing-ci` | **Date**: 2026-01-18 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-staged-testing-ci/spec.md`

## Summary

Implement a tiered testing strategy that separates fast CI tests from heavy E2E tests, with native package manager client validation for all major formats (PyPI, NPM, Maven, Cargo, Go, RPM, Debian, Conda, Helm). The approach uses Docker Compose profiles for selective test execution, air-gapped package generation from templates, and comprehensive failure/stress testing.

## Technical Context

**Language/Version**: Rust 1.75+ (backend), TypeScript 5.3 (frontend), Bash/YAML (CI workflows)
**Primary Dependencies**: GitHub Actions, Docker Compose, Playwright, Vitest, Cargo test, axum-test
**Storage**: PostgreSQL (test database), local filesystem (test artifacts)
**Testing**: cargo test (unit/integration), vitest (frontend unit), playwright (E2E), native package managers (pip, npm, cargo, dnf, apt, etc.)
**Target Platform**: GitHub Actions CI, Docker containers (Linux)
**Project Type**: Web application (backend + frontend)
**Performance Goals**: Tier 1 < 5 min, Tier 2 < 15 min, Tier 3 < 30 min
**Constraints**: Air-gapped tests (zero external network), 100 concurrent ops for stress tests
**Scale/Scope**: 9 package formats, 46 functional requirements, 15 success criteria

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. API-First Design | ✅ PASS | No new APIs; testing infrastructure only |
| II. Security by Default | ✅ PASS | TLS/GPG validation included in test requirements |
| III. Simplicity & YAGNI | ✅ PASS | Tiered approach adds only necessary complexity |
| IV. Documentation Standards | ✅ PASS | quickstart.md and comprehensive spec created |
| V. Accessibility Standards | ⬜ N/A | No UI changes |
| VI. Test Coverage | ✅ PASS | Core purpose of this feature |
| VII. Observability | ✅ PASS | Test reports and artifacts retained |

**Quality Gates**:
- Pre-Merge: Tier 1 tests (lint + unit) must pass
- Pre-Release: All tiers including E2E must pass

## Project Structure

### Documentation (this feature)

```text
specs/005-staged-testing-ci/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (CI workflow contracts)
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
# Existing structure (web application)
backend/
├── src/
│   ├── api/handlers/    # Existing handlers needing unit tests
│   └── ...
└── tests/
    ├── common/          # NEW: Shared test utilities
    │   ├── mod.rs
    │   └── fixtures.rs
    └── integration_tests.rs

frontend/
├── src/
│   ├── api/
│   │   ├── artifacts.test.ts  # NEW: Missing API tests
│   │   └── admin.test.ts      # NEW: Missing API tests
│   └── ...
├── e2e/                 # Existing Playwright tests
└── tests/

# NEW: Test infrastructure
.assets/                 # Package templates for all formats
├── pypi/
│   └── pyproject.toml
├── npm/
│   └── package.json
├── cargo/
│   └── Cargo.toml
├── maven/
│   └── pom.xml
├── go/
│   └── go.mod
├── rpm/
│   └── test-package.spec
├── debian/
│   └── debian/
├── helm/
│   └── Chart.yaml
├── conda/
│   └── meta.yaml
└── docker/
    └── Dockerfile

# NEW: CI workflows
.github/workflows/
├── ci.yml               # MODIFIED: Tier 1/2 only
├── e2e.yml              # NEW: Dedicated E2E workflow
└── release.yml          # MODIFIED: E2E gate before release

# NEW: Docker Compose profiles
docker-compose.test.yml  # MODIFIED: Add profiles for native clients
```

**Structure Decision**: Extends existing web application structure with new test infrastructure in `.assets/`, modified CI workflows, and enhanced Docker Compose configuration with profiles.

## Complexity Tracking

> No constitution violations requiring justification.

| Item | Justification |
|------|---------------|
| 9 package format profiles | Required by spec; each format has unique tooling |
| Self-signed CA + GPG keys | Required for production-realistic SSL/GPG testing |
| Air-gapped design | Required by spec; ensures CI reliability |
