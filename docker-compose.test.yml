# Docker Compose configuration for E2E Testing
# Supports Docker Compose profiles for selective test execution
#
# Usage:
#   docker compose -f docker-compose.test.yml --profile pypi up               # PyPI native client tests
#   docker compose -f docker-compose.test.yml --profile all up                # All native client tests
#
# Profiles:
#   pypi        - PyPI/pip tests (smoke)
#   npm         - NPM tests (smoke)
#   cargo       - Cargo/crates tests (smoke)
#   maven       - Maven tests
#   go          - Go modules tests
#   rpm         - RPM/dnf tests (requires gpg)
#   deb         - Debian/apt tests (requires gpg)
#   helm        - Helm chart tests
#   conda       - Conda package tests
#   docker      - Docker/OCI image tests
#   smoke       - Smoke tests only (pypi, npm, cargo)
#   all         - All native client tests

services:
  # ==========================================================================
  # INFRASTRUCTURE SERVICES (Always available)
  # ==========================================================================

  postgres:
    image: docker.io/postgres:16-alpine
    container_name: e2e-test-db
    environment:
      POSTGRES_USER: registry
      POSTGRES_PASSWORD: registry
      POSTGRES_DB: artifact_registry
    tmpfs:
      - /var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U registry -d artifact_registry"]
      interval: 2s
      timeout: 5s
      retries: 10
    networks:
      - e2e-test-network

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: e2e-test-backend
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://registry:registry@postgres:5432/artifact_registry
      STORAGE_PATH: /data/storage
      BACKUP_PATH: /data/backups
      PLUGINS_DIR: /data/plugins
      JWT_SECRET: e2e-test-secret-key-32-bytes-long
      ADMIN_PASSWORD: admin123
      RUST_LOG: info
      TRIVY_URL: http://trivy:8090
      HOST: 0.0.0.0
      PORT: 8080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 10s
      start_period: 30s
      retries: 10
    networks:
      - e2e-test-network

  trivy:
    image: aquasec/trivy:latest
    container_name: e2e-test-trivy
    command: ["server", "--listen", "0.0.0.0:8090"]
    volumes:
      - trivy-cache:/root/.cache/trivy
    networks:
      - e2e-test-network

  # Bootstrap: create test repositories after backend is healthy
  setup:
    image: alpine:3.19
    container_name: e2e-test-setup
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./scripts/e2e-setup.sh:/setup.sh:ro
    command: ["sh", "/setup.sh"]
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/.setup-done"]
      interval: 2s
      timeout: 5s
      retries: 30
    networks:
      - e2e-test-network
    profiles: ["pypi", "npm", "cargo", "maven", "go", "rpm", "deb", "helm", "conda", "docker", "smoke", "all", "redteam"]

  # PKI service: uses pre-generated files from .pki/ if available (CI), otherwise generates them (local)
  pki:
    image: alpine:3.19
    container_name: e2e-test-pki
    command: >
      sh -c "
        if [ -f /host-pki/ca.crt ] && [ -f /host-pki/server.crt ]; then
          echo 'Using pre-generated PKI files from host';
          cp -r /host-pki/* /pki/ 2>/dev/null || true;
          chmod 644 /pki/*.crt /pki/*.pub 2>/dev/null || true;
          chmod 600 /pki/*.key 2>/dev/null || true;
        else
          echo 'Generating PKI files...';
          apk add --no-cache openssl gnupg bash curl &&
          bash /scripts/pki/generate-certs.sh /pki &&
          bash /scripts/pki/generate-gpg.sh /pki;
        fi &&
        echo 'PKI setup complete' &&
        touch /pki/.ready &&
        tail -f /dev/null
      "
    volumes:
      - ./scripts/pki:/scripts/pki:ro
      - ./.pki:/host-pki:ro
      - pki-data:/pki
    healthcheck:
      test: ["CMD", "test", "-f", "/pki/.ready"]
      interval: 5s
      timeout: 5s
      retries: 20
    networks:
      - e2e-test-network
    profiles: ["pypi", "npm", "cargo", "maven", "go", "rpm", "deb", "helm", "conda", "docker", "smoke", "all", "redteam"]

  # ==========================================================================
  # SMOKE TEST SERVICES (pypi, npm, cargo)
  # ==========================================================================

  pypi-test:
    image: python:3.12-slim
    container_name: e2e-test-pypi
    depends_on:
      setup:
        condition: service_healthy
      pki:
        condition: service_healthy
    environment:
      REGISTRY_URL: http://backend:8080
      CA_CERT: /pki/ca.crt
    volumes:
      - ./scripts/native-tests:/scripts:ro
      - ./.assets:/assets:ro
      - pki-data:/pki:ro
    command: ["bash", "/scripts/test-pypi.sh"]
    networks:
      - e2e-test-network
    profiles: ["pypi", "smoke", "all"]

  npm-test:
    image: node:20-slim
    container_name: e2e-test-npm
    depends_on:
      setup:
        condition: service_healthy
      pki:
        condition: service_healthy
    environment:
      REGISTRY_URL: http://backend:8080
      CA_CERT: /pki/ca.crt
    volumes:
      - ./scripts/native-tests:/scripts:ro
      - ./.assets:/assets:ro
      - pki-data:/pki:ro
    command: ["bash", "/scripts/test-npm.sh"]
    networks:
      - e2e-test-network
    profiles: ["npm", "smoke", "all"]

  cargo-test:
    image: rust:1.75-slim
    container_name: e2e-test-cargo
    depends_on:
      setup:
        condition: service_healthy
      pki:
        condition: service_healthy
    environment:
      REGISTRY_URL: http://backend:8080
      CA_CERT: /pki/ca.crt
    volumes:
      - ./scripts/native-tests:/scripts:ro
      - ./.assets:/assets:ro
      - pki-data:/pki:ro
    command: ["bash", "/scripts/test-cargo.sh"]
    networks:
      - e2e-test-network
    profiles: ["cargo", "smoke", "all"]

  # ==========================================================================
  # EXTENDED TEST SERVICES (Require specific profiles)
  # ==========================================================================

  maven-test:
    image: maven:3.9-eclipse-temurin-21
    container_name: e2e-test-maven
    depends_on:
      setup:
        condition: service_healthy
      pki:
        condition: service_healthy
    environment:
      REGISTRY_URL: http://backend:8080
      CA_CERT: /pki/ca.crt
    volumes:
      - ./scripts/native-tests:/scripts:ro
      - ./.assets:/assets:ro
      - pki-data:/pki:ro
      - maven-cache:/root/.m2
    command: ["bash", "/scripts/test-maven.sh"]
    networks:
      - e2e-test-network
    profiles: ["maven", "all"]

  go-test:
    image: golang:1.22-alpine
    container_name: e2e-test-go
    depends_on:
      setup:
        condition: service_healthy
      pki:
        condition: service_healthy
    environment:
      REGISTRY_URL: http://backend:8080
      GOPROXY: http://backend:8080/go/test-go
      CA_CERT: /pki/ca.crt
    volumes:
      - ./scripts/native-tests:/scripts:ro
      - ./.assets:/assets:ro
      - pki-data:/pki:ro
      - go-cache:/go/pkg
    command: ["/scripts/test-go.sh"]
    networks:
      - e2e-test-network
    profiles: ["go", "all"]

  rpm-test:
    image: rockylinux/rockylinux:9-ubi-init
    container_name: e2e-test-rpm
    depends_on:
      setup:
        condition: service_healthy
      pki:
        condition: service_healthy
    environment:
      REGISTRY_URL: http://backend:8080
      CA_CERT: /pki/ca.crt
      GPG_KEY: /pki/gpg-signing.pub
    volumes:
      - ./scripts/native-tests:/scripts:ro
      - ./.assets:/assets:ro
      - pki-data:/pki:ro
    command: ["bash", "/scripts/test-rpm.sh"]
    networks:
      - e2e-test-network
    profiles: ["rpm", "all"]

  deb-test:
    image: debian:bookworm-slim
    container_name: e2e-test-deb
    depends_on:
      setup:
        condition: service_healthy
      pki:
        condition: service_healthy
    environment:
      REGISTRY_URL: http://backend:8080
      CA_CERT: /pki/ca.crt
      GPG_KEY: /pki/gpg-signing.pub
    volumes:
      - ./scripts/native-tests:/scripts:ro
      - ./.assets:/assets:ro
      - pki-data:/pki:ro
    command: ["bash", "/scripts/test-deb.sh"]
    networks:
      - e2e-test-network
    profiles: ["deb", "all"]

  helm-test:
    image: alpine/helm:3.14
    container_name: e2e-test-helm
    depends_on:
      setup:
        condition: service_healthy
      pki:
        condition: service_healthy
    environment:
      REGISTRY_URL: http://backend:8080
      CA_CERT: /pki/ca.crt
    volumes:
      - ./scripts/native-tests:/scripts:ro
      - ./.assets:/assets:ro
      - pki-data:/pki:ro
    command: ["/scripts/test-helm.sh"]
    networks:
      - e2e-test-network
    profiles: ["helm", "all"]

  conda-test:
    image: continuumio/miniconda3:latest
    container_name: e2e-test-conda
    depends_on:
      setup:
        condition: service_healthy
      pki:
        condition: service_healthy
    environment:
      REGISTRY_URL: http://backend:8080
      CA_CERT: /pki/ca.crt
    volumes:
      - ./scripts/native-tests:/scripts:ro
      - ./.assets:/assets:ro
      - pki-data:/pki:ro
    command: ["bash", "/scripts/test-conda.sh"]
    networks:
      - e2e-test-network
    profiles: ["conda", "all"]

  docker-test:
    image: docker:24-cli
    container_name: e2e-test-docker
    depends_on:
      setup:
        condition: service_healthy
      pki:
        condition: service_healthy
    environment:
      REGISTRY_URL: backend:8080
      CA_CERT: /pki/ca.crt
    volumes:
      - ./scripts/native-tests:/scripts:ro
      - ./.assets:/assets:ro
      - pki-data:/pki:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: ["/scripts/test-docker.sh"]
    networks:
      - e2e-test-network
    profiles: ["docker", "all"]

  # ==========================================================================
  # RED TEAM SECURITY TESTING
  # ==========================================================================

  redteam:
    build:
      context: .
      dockerfile: Dockerfile.redteam
    container_name: e2e-test-redteam
    depends_on:
      setup:
        condition: service_healthy
    environment:
      REGISTRY_URL: http://backend:8080
      GRPC_URL: backend:9090
      ADMIN_USER: admin
      ADMIN_PASS: admin123
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: registry
      DB_PASS: registry
      DB_NAME: artifact_registry
      RESULTS_DIR: /results
    volumes:
      - ./scripts/redteam:/scripts:ro
      - redteam-results:/results
    command: ["bash", "/scripts/run-all.sh"]
    cap_add:
      - NET_RAW
    networks:
      - e2e-test-network
    profiles: ["redteam"]

networks:
  e2e-test-network:
    name: e2e-test-network
    driver: bridge

volumes:
  pki-data:
  maven-cache:
  go-cache:
  trivy-cache:
  redteam-results:
